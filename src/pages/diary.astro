---
// æ›´æ–°å¯¼å…¥è·¯å¾„
import { diaryConfig } from "../data/diary";
import { getDiaryList, getDiaryStats } from "../data/diary";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// å¼•å…¥Markdownè§£æå™¨
import { marked } from 'marked';

// ä½¿ç”¨æ–°çš„é…ç½®å¯¹è±¡
if (!diaryConfig.enable) {
    return Astro.redirect("/404/");
}

const moments = getDiaryList();
const diaryStats = getDiaryStats();

// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰
function formatTime(dateString: string): string {
    const timeGap = diaryConfig.utcTimeZone;
    const now = new Date();
    const date = new Date(dateString);
    const diffInMinutes = Math.floor(
        (now.getTime() + timeGap * 60 * 60 * 1000 - date.getTime()) / (1000 * 60),
    );

    if (diffInMinutes < 60) {
        return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
    }
    if (diffInMinutes < 1440) {
        const hours = Math.floor(diffInMinutes / 60);
        return `${hours}${i18n(I18nKey.diaryHoursAgo)}`;
    }
    const days = Math.floor(diffInMinutes / 1440);
    return `${days}${i18n(I18nKey.diaryDaysAgo)}`;
}

// å®‰å…¨è§£æMarkdown
async function parseMarkdown(content: string): Promise<string> {
    return marked.parse(content, {
        breaks: true,
        gfm: true,
    });
}

// å‡è®¾è¿™æ˜¯ä¸€ä¸ªç»„ä»¶ä¸­çš„æ–¹æ³•
async function displayParsedContent(content: string) {
    try {
        const parsedContent = await parseMarkdown(content);
        // è¿™é‡Œå¯ä»¥å°†è§£æåçš„å†…å®¹è®¾ç½®åˆ°ç»„ä»¶çš„çŠ¶æ€ä¸­
        // ä¾‹å¦‚ï¼šthis.setState({ parsedContent });
        console.log(parsedContent);
    } catch (error) {
        console.error('è§£æMarkdownæ—¶å‡ºé”™:', error);
        // å¤„ç†è§£æé”™è¯¯
    }
}

// å‡è®¾è¿™æ˜¯åœ¨æŸä¸ªäº‹ä»¶è§¦å‘æ—¶è°ƒç”¨ displayParsedContent
// ä¾‹å¦‚åœ¨æŸä¸ªæŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸­
async function onButtonClick() {
    const content = "è¿™æ˜¯è¦è§£æçš„Markdownå†…å®¹";
    await displayParsedContent(content);
}

---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
    <script>
        import('../scripts/right-sidebar-layout.js');
    </script>
    
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
            <div class="relative max-w-4xl w-full px-2 md:px-0">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="moments-header mb-6">
                    <div class="header-content">
                        <div class="header-info">
                            <h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1">{i18n(I18nKey.diary)}</h1>
                            <p class="moments-subtitle text-sm md:text-base lg:text-lg text-75">{i18n(I18nKey.diarySubtitle)}</p>
                        </div>
                        <div class="header-stats">
                            <div class="stat-item text-center">
                                <span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-[var(--primary)]">{diaryStats.total}</span>
                                <span class="stat-label text-xs md:text-sm lg:text-base text-75">{i18n(I18nKey.diaryCount)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çŸ­æ–‡åˆ—è¡¨ -->
                <div class="moments-timeline">
                    <div class="timeline-list space-y-4">
                        {moments.map(moment => (
                            <div class="moment-item card-base p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all">
                                <div class="moment-content">
                                    <!-- ä½¿ç”¨Markdownè§£æ -->
                                    <div class="wenzi moment-text text-sm md:text-base lg:text-lg text-90 leading-relaxed mb-3 md:mb-4" 
                                         set:html={parseMarkdown(moment.content)} />
                                    
                                    {moment.images && moment.images.length > 0 && (
  <div class="moment-images flex flex-wrap gap-2 md:gap-3 lg:gap-4 mb-3 md:mb-4">
  {((moment.images ?? [])).length > 0 && (
    (moment.images ?? []).map((image) => (
      <div class={`
        ${((moment.images ?? []).length === 1 ? 'w-full' : 
          (moment.images ?? []).length === 2 ? 'w-[calc(50%-0.5rem)]' : 
          'w-[calc(33.333%-0.666rem)]')}
        relative rounded-md overflow-hidden aspect-square cursor-pointer
      `}>
        <img 
          src={image} 
          alt="diary moment image"
          class="w-full h-full object-cover hover:scale-105 transition-transform"
          loading="lazy" />
      </div>
    ))
  )}
</div>
)}
                                </div>
                                
                                <hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4" />
                                
                                <div class="moment-footer flex justify-between items-center">
                                    <div class="moment-time flex items-center gap-1.5 text-75 text-xs md:text-sm lg:text-base">
                                        <i class="time-icon text-xs md:text-sm">ğŸ•</i>
                                        <time datetime={moment.date}>
                                            {formatTime(moment.date)}
                                        </time>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                <!-- åº•éƒ¨æç¤º -->
                <div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
                    {i18n(I18nKey.diaryTips)}
                </div>
            </div>
        </div>
    </div>
</MainGridLayout>

<style>
    .card-base {
        background: var(--card-bg);
        border: 1px solid var(--line-divider);
        transition: all 0.3s ease;
    }
    
    /* Markdownæ¸²æŸ“æ ·å¼ */
    .wenzi :global(h1), 
    .wenzi :global(h2), 
    .wenzi :global(h3), 
    .wenzi :global(h4), 
    .wenzi :global(h5), 
    .wenzi :global(h6) {
        margin: 1.2em 0 0.8em;
        font-weight: bold;
    }
    
    .wenzi :global(p) {
        margin: 1em 0;
    }
    
    .wenzi :global(ul), 
    .wenzi :global(ol) {
        padding-left: 1.5em;
        margin: 1em 0;
    }
    
    .wenzi :global(li) {
        margin: 0.5em 0;
    }
    
    .wenzi :global(blockquote) {
        border-left: 4px solid var(--primary);
        padding-left: 1em;
        margin: 1.2em 0;
        color: var(--text-muted);
    }
    
    .wenzi :global(code) {
        background: var(--code-bg);
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-family: 'Fira Code', monospace;
    }
    
    .wenzi :global(pre) {
        background: var(--code-block-bg);
        padding: 1em;
        border-radius: 8px;
        overflow: auto;
        margin: 1.2em 0;
    }
    
    .wenzi :global(pre code) {
        background: none;
        padding: 0;
        border-radius: 0;
    }
    
    .wenzi :global(a) {
        color: var(--primary);
        text-decoration: underline;
    }
    
    .wenzi :global(a:hover) {
        text-decoration: none;
    }
    
    .wenzi :global(img) {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1em 0;
    }
    
    /* å›¾ç‰‡å°ºå¯¸ä¼˜åŒ– */
    .image-item {
        max-width: 150px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
    }
    
    /* ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šä¹Ÿæœ‰è‰¯å¥½çš„æ˜¾ç¤º */
    @media (max-width: 640px) {
        .wenzi {
            line-height: 1.7 !important;
            font-size: 0.95rem !important;
        }
        
        /* ç§»åŠ¨ç«¯å›¾ç‰‡æ›´å° */
        .moment-images {
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 0.5rem !important;
        }
        
        .image-item {
            max-width: 100px;
        }
    }
    
    .moments-header {
        padding: 1rem;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, var(--primary)) 100%);
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
    }
    
    .moments-title {
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .moments-subtitle {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .stat-number {
        color: white;
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 640px) {
        .moments-header {
            padding: 0.75rem;
        }
        
        .header-content {
            flex-direction: column;
            text-align: center;
            gap: 0.75rem;
        }
        
        .moment-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
    
    @media (min-width: 641px) and (max-width: 900px) {
        .moments-header {
            padding: 1.25rem;
        }
        
        .moment-item {
            padding: 1.5rem;
        }
        
        .moment-images {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            max-width: 500px;
        }
        
        .moment-text {
            font-size: 1rem;
            line-height: 1.7;
        }
    }
    
    @media (min-width: 901px) {
        .moments-header {
            padding: 1.5rem;
        }
        
        .moment-item {
            padding: 2rem;
        }
        
        .moment-images {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            max-width: 600px;
            gap: 1rem;
        }
        
        .moment-text {
            font-size: 1.1rem;
            line-height: 1.8;
        }
    }
    
    @media (max-width: 480px) {
        .moment-item {
            border-radius: 8px;
        }
        
        .moments-header {
            border-radius: 6px;
        }
        
        /* è¶…å°å±å¹•å›¾ç‰‡å¸ƒå±€ */
        .moment-images {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
</style>